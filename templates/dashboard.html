{% extends 'base.html' %}
{% load static %}

{% block content %}
    <style>
        .container {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
            margin-right: 5px;
            font-size: 0.9em;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            font-size: 0.9em;
        }

        .card {
            background: white;
            border-left: 5px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        /* –¶–≤–µ—Ç–æ–≤–µ –∑–∞ —Å—Ç–∞—Ç—É—Å–∏—Ç–µ */
        .status-confirmed {
            border-left-color: #28a745;
            background-color: #f0fff4;
        }

        .status-cancelled {
            border-left-color: #dc3545;
            opacity: 0.6;
            text-decoration: line-through;
        }

        .status-pending {
            border-left-color: #ffc107;
        }

        .info-group {
            flex: 1;
            min-width: 250px;
        }

        .info-row {
            margin: 5px 0;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .date-badge {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
    </style>

    <h1>üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ì—Ä–∞—Ñ–∏–∫–∞</h1>

    <div class="controls">
        <input type="date" id="datePicker">
        <button class="btn-primary" onclick="loadSchedule(true)">üîé –¢—ä—Ä—Å–∏ –∑–∞ –¥–∞—Ç–∞</button>
        <button class="btn-primary" onclick="loadSchedule(false)">üìã –í—Å–∏—á–∫–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏</button>
    </div>

    <div id="schedule-container">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –≤–∑–∏–º–∞–Ω–µ –Ω–∞ CSRF —Ç–æ–∫–µ–Ω (–Ω—É–∂–µ–Ω –∑–∞ POST/PATCH –∑–∞—è–≤–∫–∏)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function loadSchedule(filterByDate = false) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '<p style="text-align:center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏...</p>';

            let url = '/api/my-schedule/';

            // –ê–∫–æ —Å–º–µ –Ω–∞—Ç–∏—Å–Ω–∞–ª–∏ –±—É—Ç–æ–Ω–∞ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –¥–∞—Ç–∞
            if (filterByDate) {
                const dateVal = document.getElementById('datePicker').value;
                if (dateVal) {
                    url += `?date=${dateVal}`;
                } else {
                    alert("–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –¥–∞—Ç–∞!");
                    return;
                }
            }

            try {
                const response = await fetch(url);

                if (response.status === 403) {
                    container.innerHTML = '<p style="color:red; text-align:center">‚ö†Ô∏è –ù—è–º–∞—Ç–µ –¥–æ—Å—Ç—ä–ø! –í–ª–µ–∑—Ç–µ –∫–∞—Ç–æ —Å–ª—É–∂–∏—Ç–µ–ª.</p>';
                    return;
                }

                const appointments = await response.json();

                if (appointments.length === 0) {
                    container.innerHTML = '<p style="text-align:center">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏.</p>';
                    return;
                }

                let html = '';
                appointments.forEach(app => {
                    // –û–ø—Ä–µ–¥–µ–ª—è–º–µ CSS –∫–ª–∞—Å–∞ —Å–ø–æ—Ä–µ–¥ —Å—Ç–∞—Ç—É—Å–∞
                    let statusClass = 'status-pending';
                    if (app.status === 'confirmed') statusClass = 'status-confirmed';
                    if (app.status === 'cancelled') statusClass = 'status-cancelled';

                    // –ë—É—Ç–æ–Ω–∏—Ç–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç —Å–∞–º–æ –∞–∫–æ —Å—Ç–∞—Ç—É—Å—ä—Ç –Ω–µ –µ –æ—Ç–∫–∞–∑–∞–Ω
                    let actionButtons = '';
                    if (app.status !== 'cancelled') {
                        actionButtons = `
                            <div class="actions">
                                ${app.status !== 'confirmed' ? `<button class="btn-success" onclick="updateStatus(${app.id}, 'confirmed')">‚úî –ü–æ—Ç–≤—ä—Ä–¥–∏</button>` : ''}
                                <button class="btn-danger" onclick="updateStatus(${app.id}, 'cancelled')">‚úñ –û—Ç–∫–∞–∂–∏</button>
                            </div>
                        `;
                    }

                    html += `
                        <div class="card ${statusClass}">
                            <div class="info-group">
                                <div class="info-row"><span class="date-badge">${app.date}</span> <strong>‚è∞ ${app.time.slice(0, 5)}</strong></div>
                                <div class="info-row">üë§ <strong>${app.client_name}</strong> (${app.service_name})</div>
                                <div class="info-row">üìû <a href="tel:${app.client_phone}">${app.client_phone}</a></div>
                                <div class="info-row">–°—Ç–∞—Ç—É—Å: <i>${app.status_display}</i></div>
                            </div>
                            ${actionButtons}
                        </div>
                    `;
                });
                container.innerHTML = html;

            } catch (error) {
                console.error(error);
                container.innerHTML = '<p style="color:red; text-align:center">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ä—ä–∑–∫–∞ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞.</p>';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å
        async function updateStatus(id, newStatus) {
            if (!confirm("–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å–∞?")) return;

            try {
                const response = await fetch(`/api/appointment/${id}/status/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({status: newStatus})
                });

                if (response.ok) {
                    // –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ —Å–ø–∏—Å—ä–∫–∞, –∑–∞ –¥–∞ –≤–∏–¥–∏–º –ø—Ä–æ–º—è–Ω–∞—Ç–∞
                    // –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º–µ –¥–∞–ª–∏ –∏–º–∞ –¥–∞—Ç–∞ –≤ –ø–æ–ª–µ—Ç–æ, –∑–∞ –¥–∞ –∑–Ω–∞–µ–º –∫–æ–π –≤–∏–¥ –¥–∞ –∑–∞—Ä–µ–¥–∏–º
                    const dateVal = document.getElementById('datePicker').value;
                    if (dateVal) loadSchedule(true);
                    else loadSchedule(false);
                } else {
                    alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ!");
                }
            } catch (error) {
                console.error('Error:', error);
                alert("–ú—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞.");
            }
        }

        // –ó–∞—Ä–µ–¥–∏ –≤—Å–∏—á–∫–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
        loadSchedule(false);
    </script>

{% endblock %}